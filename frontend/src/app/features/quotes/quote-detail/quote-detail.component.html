<div class="quote-detail-container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <button mat-icon-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-info">
        <h1 *ngIf="quote">{{quote.title}}</h1>
        <div class="quote-number" *ngIf="quote">
          Cotización #{{quote.quoteNumber}}
        </div>
      </div>
    </div>
    <div class="header-actions" *ngIf="quote">
      <button mat-stroked-button (click)="editQuote()">
        <mat-icon>edit</mat-icon>
        Editar
      </button>
      <button mat-button [matMenuTriggerFor]="actionsMenu">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #actionsMenu="matMenu">
        <button mat-menu-item (click)="sendQuote()">
          <mat-icon>send</mat-icon>
          <span>Enviar cotización</span>
        </button>
        <button mat-menu-item (click)="duplicateQuote()">
          <mat-icon>content_copy</mat-icon>
          <span>Duplicar</span>
        </button>
        <button mat-menu-item (click)="downloadPDF()">
          <mat-icon>download</mat-icon>
          <span>Descargar PDF</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="acceptQuote()" 
                [disabled]="quote.status !== 'sent'">
          <mat-icon>check_circle</mat-icon>
          <span>Aceptar</span>
        </button>
        <button mat-menu-item (click)="rejectQuote()" 
                [disabled]="quote.status !== 'sent'">
          <mat-icon>cancel</mat-icon>
          <span>Rechazar</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Quote Details -->
  <div *ngIf="!loading && quote" class="quote-content">
    <!-- Basic Information -->
    <mat-card class="info-section">
      <mat-card-header>
        <mat-card-title>Información General</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <label>Cliente:</label>
            <span>{{client?.name || 'Cargando...'}}</span>
          </div>
          <div class="info-item" *ngIf="project">
            <label>Proyecto:</label>
            <span>{{project.name}}</span>
          </div>
          <div class="info-item">
            <label>Estado:</label>
            <mat-chip [class]="'status-' + quote.status">
              {{getStatusLabel(quote.status)}}
            </mat-chip>
          </div>
          <div class="info-item" *ngIf="quote.validUntil">
            <label>Válida hasta:</label>
            <span [class.expired]="isExpired(quote.validUntil)">
              {{formatDate(quote.validUntil)}}
              <mat-icon *ngIf="isExpired(quote.validUntil)" class="warning-icon">warning</mat-icon>
            </span>
          </div>
          <div class="info-item" *ngIf="quote.description">
            <label>Descripción:</label>
            <span>{{quote.description}}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Items -->
    <mat-card class="items-section">
      <mat-card-header>
        <mat-card-title>Items de la Cotización</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="quote.items || []" class="items-table">
            <!-- Description Column -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Descripción</th>
              <td mat-cell *matCellDef="let item">
                <div class="item-description">
                  <strong>{{item.description}}</strong>
                  <div *ngIf="item.notes" class="item-notes">{{item.notes}}</div>
                </div>
              </td>
            </ng-container>

            <!-- Quantity Column -->
            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let item">
                {{item.quantity}} {{item.unit}}
              </td>
            </ng-container>

            <!-- Unit Price Column -->
            <ng-container matColumnDef="unitPrice">
              <th mat-header-cell *matHeaderCellDef>Precio Unitario</th>
              <td mat-cell *matCellDef="let item">
                {{item.unitPrice | currency:'USD':'symbol':'1.2-2'}}
              </td>
            </ng-container>

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let item">
                <strong>{{(item.quantity * item.unitPrice) | currency:'USD':'symbol':'1.2-2'}}</strong>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <!-- Quote Totals -->
        <div class="quote-totals">
          <div class="totals-row">
            <span>Subtotal:</span>
            <span>{{quote.subtotal | currency:'USD':'symbol':'1.2-2'}}</span>
          </div>
          <div class="totals-row" *ngIf="quote.discount > 0">
            <span>Descuento:</span>
            <span>-{{quote.discount | currency:'USD':'symbol':'1.2-2'}}</span>
          </div>
          <div class="totals-row" *ngIf="quote.taxRate > 0">
            <span>Impuestos ({{quote.taxRate}}%):</span>
            <span>{{quote.taxAmount | currency:'USD':'symbol':'1.2-2'}}</span>
          </div>
          <div class="totals-row total-row">
            <span><strong>Total:</strong></span>
            <span><strong>{{quote.total | currency:'USD':'symbol':'1.2-2'}}</strong></span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Additional Information -->
    <div class="additional-info">
      <!-- Notes -->
      <mat-card *ngIf="quote.notes" class="notes-section">
        <mat-card-header>
          <mat-card-title>Notas</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p>{{quote.notes}}</p>
        </mat-card-content>
      </mat-card>

      <!-- Terms -->
      <mat-card *ngIf="quote.terms" class="terms-section">
        <mat-card-header>
          <mat-card-title>Términos y Condiciones</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p class="terms-text">{{quote.terms}}</p>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- System Information -->
    <mat-card class="system-info">
      <mat-card-header>
        <mat-card-title>Información del Sistema</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <label>Creado:</label>
            <span>{{formatDate(quote.createdAt)}}</span>
          </div>
          <div class="info-item">
            <label>Última actualización:</label>
            <span>{{formatDate(quote.updatedAt)}}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>